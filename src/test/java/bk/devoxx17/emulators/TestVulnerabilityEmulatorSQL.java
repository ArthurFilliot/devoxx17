package bk.devoxx17.emulators;

import java.util.ArrayList;
import java.util.Collection;

import org.junit.After;
import org.junit.Before;
import org.junit.runner.RunWith;
import org.junit.runners.Parameterized;
import org.junit.runners.Parameterized.Parameters;

import bk.devoxx17.emulators.databases.DatabaseSQL;
import bk.devoxx17.front.Dispatcher;
import bk.devoxx17.front.Front;
import bk.devoxx17.front.InjectionMethod;
import bk.devoxx17.test.DatabaseSQLHelper;

@RunWith(Parameterized.class)
public class TestVulnerabilityEmulatorSQL extends AbstractTestVulnerabilityEmulator {

	public TestVulnerabilityEmulatorSQL(VulnerabilityEmulator emulator, InjectionMethod method) {
		this.emulator = emulator;
		this.breakingMethod = method;
	}
	
	@Before
	public void init() {
		DatabaseSQLHelper.init();
		DatabaseSQL db = DatabaseSQLHelper.getDb();
		String createSchema = db.getScript("/sql/schema.sql");
		String insertUsers = db.getScript("/sql/users.sql");
		db.executeScript(createSchema);
		db.executeScript(insertUsers);
	}

	@After
	public void terminate() {
		DatabaseSQLHelper.terminate();
	}

	@Parameters
	public static Collection<Object[]> data() {
		Collection<Object[]> data = new ArrayList<Object[]>();
		for (InjectionMethod method : InjectionMethod.values()) {
			VulnerabilityEmulator emulator = Dispatcher.selectEmulator(method);
			if (emulator instanceof VulnerabilityEmulatorSQL) {
				((VulnerabilityEmulatorSQL) emulator).setDb(DatabaseSQLHelper.getDb());
				data.add(new Object[] {emulator, method});
			}
		}
		return data;
	}
}
